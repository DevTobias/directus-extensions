"use strict";var be=Object.create;var F=Object.defineProperty;var ge=Object.getOwnPropertyDescriptor;var ye=Object.getOwnPropertyNames;var we=Object.getPrototypeOf,Oe=Object.prototype.hasOwnProperty;var Te=(e,t)=>{for(var r in t)F(e,r,{get:t[r],enumerable:!0})},P=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of ye(t))!Oe.call(e,n)&&n!==r&&F(e,n,{get:()=>t[n],enumerable:!(o=ge(t,n))||o.enumerable});return e};var O=(e,t,r)=>(r=e!=null?be(we(e)):{},P(t||!e||!e.__esModule?F(r,"default",{value:e,enumerable:!0}):r,e)),ve=e=>P(F({},"__esModule",{value:!0}),e);var ut={};Te(ut,{default:()=>at});module.exports=ve(ut);var ce=O(require("path"),1),fe=O(require("crypto"),1);var L=async e=>new Promise((t,r)=>{let o=Array();e.on("data",n=>o.push(n)),e.on("end",()=>t(Buffer.concat(o))),e.on("error",n=>r(n))});var Ce=O(require("sharp"),1);var y=Symbol("image metadata");function a(e,t,r){e[y]&&(e[y][t]=r)}function z(e,t){var r;return(r=e[y])===null||r===void 0?void 0:r[t]}var S=({background:e},t)=>{if(!(typeof e!="string"||!e.length))return a(t,"background",e),e},Re=e=>{let t;if(t=e.blur?parseFloat(e.blur):void 0,t||(t=e.blur==="true"),t||(t=e.blur===""),!!t)return function(o){return a(o,"blur",t),o.blur(t)}},G=["cover","contain","fill","inside","outside"],Ae=(e,t)=>{let r;if(e.fit&&G.includes(e.fit)?r=e.fit:r=Object.keys(e).find(o=>G.includes(o)&&e[o]===""),!!r)return a(t,"fit",r),r},Fe=e=>{if(!(e.flatten!==""&&e.flatten!=="true"))return function(r){return a(r,"flatten",!0),r.flatten({background:S(e,r)})}},xe=({flip:e})=>{if(!(e!==""&&e!=="true"))return function(r){return a(r,"flip",!0),r.flip()}},Be=({flop:e})=>{if(!(e!==""&&e!=="true"))return function(r){return a(r,"flop",!0),r.flop()}},Ee=({quality:e},t)=>{let r=e&&parseInt(e);if(r)return a(t,"quality",r),r},Se=({progressive:e},t)=>{if(!(e!==""&&e!=="true"))return a(t,"progressive",!0),!0},U=["avif","jpg","jpeg","png","heif","heic","webp","tiff"],Ie=e=>{let t;if(e.format&&U.includes(e.format)?t=e.format:t=Object.keys(e).find(o=>U.includes(o)&&e[o]===""),!t)return;let r=t;return function(n){return a(n,"format",t),n.toFormat(r,{quality:Ee(e,n),progressive:Se(e,n)})}},Me=({grayscale:e})=>{if(!(e!==""&&e!=="true"))return function(r){return a(r,"grayscale",!0),r.grayscale()}},$e=e=>{let t=e.hue&&parseInt(e.hue),r=e.saturation&&parseFloat(e.saturation),o=e.brightness&&parseFloat(e.brightness);if(!(!t&&!r&&!o))return function(s){return a(s,"hue",t),a(s,"saturation",r),a(s,"brightness",o),s.modulate({hue:t||0,saturation:r||1,brightness:o||1})}},Ne=({invert:e})=>{if(!(e!==""&&e!=="true"))return function(r){return a(r,"invert",!0),r.negate()}},je=["nearest","cubic","mitchell","lanczos2","lanczos3"],_e=({kernel:e},t)=>{if(e&&je.includes(e))return a(t,"kernel",e),e},ke=e=>{let t=e.median?parseInt(e.median):void 0;if(t)return function(o){return a(o,"median",t),o.median(t)}},Pe=({normalize:e})=>{if(!(e!==""&&e!=="true"))return function(r){return a(r,"normalize",!0),r.normalize()}},Le=["top","right top","right","right bottom","bottom","left bottom","left","left top","north","northeast","east","southeast","south","southwest","west","northwest","center","centre","entropy","attention"],ze=["top","right top","right","right bottom","bottom","left bottom","left","left top"],Ge=(e,t)=>{let r;if(e.position&&Le.includes(e.position)?r=e.position:r=Object.keys(e).find(o=>ze.includes(o)&&e[o]===""),!!r)return a(t,"position",r),r};function Ue(e){let t=e.split(":"),r;if(t.length===1)r=parseFloat(t[0]);else if(t.length===2){let[o,n]=t.map(s=>parseInt(s));if(!o||!n)return;r=o/n}if(!(!r||r<=0))return r}var De=(e,t)=>{let r=parseInt(e.width||e.w||""),o=parseInt(e.height||e.h||""),n=Ue(e.aspect||e.ar||""),s=e.withoutEnlargement===""||e.withoutEnlargement==="true",i=e.withoutReduction===""||e.withoutReduction==="true";if(!(!r&&!o&&!n||e.withoutEnlargement&&!s||e.withoutReduction&&!i))return function(l){let p=z(l,"width"),b=z(l,"height"),w=p/b,d=r,g=o,C=n;return n&&!r&&!o?n>w?(g=p/n,d=p):(g=b,d=b/n):o?r||(d=o*(n||w)):g=r/(n||w),(s&&(g>b||d>p)||i&&(g<b||d<p))&&(g=b,d=p,C=w,t.logger.info("withoutEnlargement or withoutReduction enabled. Image width, height and aspect ratio reverted to original values")),a(l,"height",g),a(l,"width",d),a(l,"aspect",C),a(l,"withoutEnlargement",s),a(l,"withoutReduction",i),l.resize({width:Math.round(d)||void 0,height:Math.round(g)||void 0,withoutEnlargement:s,withoutReduction:i,fit:Ae(e,l),position:Ge(e,l),kernel:_e(e,l),background:S(e,l)})}},Ye=e=>{let t=e.rotate&&parseInt(e.rotate);if(t)return function(o){return a(o,"rotate",t),o.rotate(t,{background:S(e,o)})}},Ve=({tint:e})=>{if(!(typeof e!="string"||!e.length))return function(r){return a(r,"tint","#"+e),r.tint("#"+e)}},D=[Re,Fe,xe,Be,Ie,Me,$e,Ne,ke,Pe,De,Ye,Ve];var He={info(e){console.info(e)},warn(e){console.warn(e)},error(e){console.error(e)}};function Y(e,t,r){r===void 0&&(r=He);let o=[],n=new Set,s={useParam:i=>n.add(i),logger:r};for(let i of t){let f=i(e,s);typeof f=="function"&&o.push(f)}return{transforms:o,parametersUsed:n}}async function V(e,t,r=!0){t[y]=await t.metadata(),r?(delete t[y].exif,delete t[y].iptc,delete t[y].xmp,delete t[y].tifftagPhotoshop,delete t[y].icc):t.withMetadata();for(let o of e)t=await o(t);return{image:t,metadata:t[y]}}var se=O(require("sharp"),1),ie=O(require("crypto"),1);var H=(e=0)=>t=>`\x1B[${t+e}m`,W=(e=0)=>t=>`\x1B[${38+e};5;${t}m`,K=(e=0)=>(t,r,o)=>`\x1B[${38+e};2;${t};${r};${o}m`,u={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],gray:[90,39],grey:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgGray:[100,49],bgGrey:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}},q=Object.keys(u.modifier),I=Object.keys(u.color),M=Object.keys(u.bgColor),J=[...I,...M];function We(){let e=new Map;for(let[t,r]of Object.entries(u)){for(let[o,n]of Object.entries(r))u[o]={open:`\x1B[${n[0]}m`,close:`\x1B[${n[1]}m`},r[o]=u[o],e.set(n[0],n[1]);Object.defineProperty(u,t,{value:r,enumerable:!1})}return Object.defineProperty(u,"codes",{value:e,enumerable:!1}),u.color.close="\x1B[39m",u.bgColor.close="\x1B[49m",u.color.ansi=H(),u.color.ansi256=W(),u.color.ansi16m=K(),u.bgColor.ansi=H(10),u.bgColor.ansi256=W(10),u.bgColor.ansi16m=K(10),Object.defineProperties(u,{rgbToAnsi256:{value(t,r,o){return t===r&&r===o?t<8?16:t>248?231:Math.round((t-8)/247*24)+232:16+36*Math.round(t/255*5)+6*Math.round(r/255*5)+Math.round(o/255*5)},enumerable:!1},hexToRgb:{value(t){let r=/[a-f\d]{6}|[a-f\d]{3}/i.exec(t.toString(16));if(!r)return[0,0,0];let[o]=r;o.length===3&&(o=[...o].map(s=>s+s).join(""));let n=Number.parseInt(o,16);return[n>>16&255,n>>8&255,n&255]},enumerable:!1},hexToAnsi256:{value:t=>u.rgbToAnsi256(...u.hexToRgb(t)),enumerable:!1},ansi256ToAnsi:{value(t){if(t<8)return 30+t;if(t<16)return 90+(t-8);let r,o,n;if(t>=232)r=((t-232)*10+8)/255,o=r,n=r;else{t-=16;let f=t%36;r=Math.floor(t/36)/5,o=Math.floor(f/6)/5,n=f%6/5}let s=Math.max(r,o,n)*2;if(s===0)return 30;let i=30+(Math.round(n)<<2|Math.round(o)<<1|Math.round(r));return s===2&&(i+=60),i},enumerable:!1},rgbToAnsi:{value:(t,r,o)=>u.ansi256ToAnsi(u.rgbToAnsi256(t,r,o)),enumerable:!1},hexToAnsi:{value:t=>u.ansi256ToAnsi(u.hexToAnsi256(t)),enumerable:!1}}),u}var Ke=We(),h=Ke;var B=O(require("node:process"),1),X=O(require("node:os"),1),$=O(require("node:tty"),1);function m(e,t=globalThis.Deno?globalThis.Deno.args:B.default.argv){let r=e.startsWith("-")?"":e.length===1?"-":"--",o=t.indexOf(r+e),n=t.indexOf("--");return o!==-1&&(n===-1||o<n)}var{env:c}=B.default,x;m("no-color")||m("no-colors")||m("color=false")||m("color=never")?x=0:(m("color")||m("colors")||m("color=true")||m("color=always"))&&(x=1);function qe(){if("FORCE_COLOR"in c)return c.FORCE_COLOR==="true"?1:c.FORCE_COLOR==="false"?0:c.FORCE_COLOR.length===0?1:Math.min(Number.parseInt(c.FORCE_COLOR,10),3)}function Je(e){return e===0?!1:{level:e,hasBasic:!0,has256:e>=2,has16m:e>=3}}function Qe(e,{streamIsTTY:t,sniffFlags:r=!0}={}){let o=qe();o!==void 0&&(x=o);let n=r?x:o;if(n===0)return 0;if(r){if(m("color=16m")||m("color=full")||m("color=truecolor"))return 3;if(m("color=256"))return 2}if("TF_BUILD"in c&&"AGENT_NAME"in c)return 1;if(e&&!t&&n===void 0)return 0;let s=n||0;if(c.TERM==="dumb")return s;if(B.default.platform==="win32"){let i=X.default.release().split(".");return Number(i[0])>=10&&Number(i[2])>=10586?Number(i[2])>=14931?3:2:1}if("CI"in c)return"GITHUB_ACTIONS"in c?3:["TRAVIS","CIRCLECI","APPVEYOR","GITLAB_CI","BUILDKITE","DRONE"].some(i=>i in c)||c.CI_NAME==="codeship"?1:s;if("TEAMCITY_VERSION"in c)return/^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(c.TEAMCITY_VERSION)?1:0;if(c.COLORTERM==="truecolor"||c.TERM==="xterm-kitty")return 3;if("TERM_PROGRAM"in c){let i=Number.parseInt((c.TERM_PROGRAM_VERSION||"").split(".")[0],10);switch(c.TERM_PROGRAM){case"iTerm.app":return i>=3?3:2;case"Apple_Terminal":return 2}}return/-256(color)?$/i.test(c.TERM)?2:/^screen|^xterm|^vt100|^vt220|^rxvt|color|ansi|cygwin|linux/i.test(c.TERM)||"COLORTERM"in c?1:s}function Q(e,t={}){let r=Qe(e,{streamIsTTY:e&&e.isTTY,...t});return Je(r)}var Xe={stdout:Q({isTTY:$.default.isatty(1)}),stderr:Q({isTTY:$.default.isatty(2)})},Z=Xe;function ee(e,t,r){let o=e.indexOf(t);if(o===-1)return e;let n=t.length,s=0,i="";do i+=e.slice(s,o)+t+r,s=o+n,o=e.indexOf(t,s);while(o!==-1);return i+=e.slice(s),i}function te(e,t,r,o){let n=0,s="";do{let i=e[o-1]==="\r";s+=e.slice(n,i?o-1:o)+t+(i?`\r
`:`
`)+r,n=o+1,o=e.indexOf(`
`,n)}while(o!==-1);return s+=e.slice(n),s}var{stdout:re,stderr:oe}=Z,N=Symbol("GENERATOR"),T=Symbol("STYLER"),R=Symbol("IS_EMPTY"),ne=["ansi","ansi","ansi256","ansi16m"],v=Object.create(null),Ze=(e,t={})=>{if(t.level&&!(Number.isInteger(t.level)&&t.level>=0&&t.level<=3))throw new Error("The `level` option should be an integer from 0 to 3");let r=re?re.level:0;e.level=t.level===void 0?r:t.level};var et=e=>{let t=(...r)=>r.join(" ");return Ze(t,e),Object.setPrototypeOf(t,A.prototype),t};function A(e){return et(e)}Object.setPrototypeOf(A.prototype,Function.prototype);for(let[e,t]of Object.entries(h))v[e]={get(){let r=E(this,_(t.open,t.close,this[T]),this[R]);return Object.defineProperty(this,e,{value:r}),r}};v.visible={get(){let e=E(this,this[T],!0);return Object.defineProperty(this,"visible",{value:e}),e}};var j=(e,t,r,...o)=>e==="rgb"?t==="ansi16m"?h[r].ansi16m(...o):t==="ansi256"?h[r].ansi256(h.rgbToAnsi256(...o)):h[r].ansi(h.rgbToAnsi(...o)):e==="hex"?j("rgb",t,r,...h.hexToRgb(...o)):h[r][e](...o),tt=["rgb","hex","ansi256"];for(let e of tt){v[e]={get(){let{level:r}=this;return function(...o){let n=_(j(e,ne[r],"color",...o),h.color.close,this[T]);return E(this,n,this[R])}}};let t="bg"+e[0].toUpperCase()+e.slice(1);v[t]={get(){let{level:r}=this;return function(...o){let n=_(j(e,ne[r],"bgColor",...o),h.bgColor.close,this[T]);return E(this,n,this[R])}}}}var rt=Object.defineProperties(()=>{},{...v,level:{enumerable:!0,get(){return this[N].level},set(e){this[N].level=e}}}),_=(e,t,r)=>{let o,n;return r===void 0?(o=e,n=t):(o=r.openAll+e,n=t+r.closeAll),{open:e,close:t,openAll:o,closeAll:n,parent:r}},E=(e,t,r)=>{let o=(...n)=>ot(o,n.length===1?""+n[0]:n.join(" "));return Object.setPrototypeOf(o,rt),o[N]=e,o[T]=t,o[R]=r,o},ot=(e,t)=>{if(e.level<=0||!t)return e[R]?"":t;let r=e[T];if(r===void 0)return t;let{openAll:o,closeAll:n}=r;if(t.includes("\x1B"))for(;r!==void 0;)t=ee(t,r.close,r.open),r=r.parent;let s=t.indexOf(`
`);return s!==-1&&(t=te(t,n,o,s)),o+t+n};Object.defineProperties(A.prototype,v);var Tt=A(),vt=A({level:oe?oe.level:0});var nt={jpg:"image/jpeg",webp:"image/webp",avif:"image/avif"},st=async e=>`data:image/webp;base64,${(await e.resize(10).webp({quality:50}).toBuffer({resolveWithObject:!1})).toString("base64")}`,it=(e,t,r)=>t/(e/r),lt=async(e,t)=>{let r=await e.metadata();if(!r.width||!r.height)throw new Error("could not retrieve image metadata");let o=it(r.width,r.height,t.width),n={...t,height:o},{transforms:s}=Y(n,D),{image:i}=await V(s,e);return[i,o]},le=async(e,t,r)=>{let o=(0,se.default)(r),n=Promise.all(e.map(async l=>Promise.all(t.map(async p=>{let[b,w]=await lt(o,{format:l,width:p}),d=ie.default.randomBytes(5).toString("hex");return{name:`${l}-${p}-${Math.floor(w)}-${d}.${l}`,buffer:b.toBuffer(),type:nt[l],width:p,height:w}})))),s=st(o),[i,f]=await Promise.all([s,n]);return{placeholder:i,images:f.flat()}};var k=require("stream"),ae=e=>e?.o_profile!==void 0&&typeof e.o_profile=="string",ue=async({buffer:e,originalName:t,folder:r,service:o,storage:n="local"})=>{let s=await le(["jpg","webp","avif"],[400,800,1e3],e),i=s.images.map(async l=>o.uploadOne(k.Readable.from(await l.buffer),{folder:r,storage:n,type:l.type,metadata:{isOptimized:!0},title:`${t}-${l.name}`,filename_download:`${t}-${l.name}`})),f=o.uploadOne(k.Readable.from(""),{folder:r,storage:n,type:"text/plain",metadata:{isOptimized:!0},title:`${t}-placeholder`,description:s.placeholder,filename_download:`${t}-placeholder`});return Promise.all([...i,f])};var at=({filter:e},{services:t})=>{let{FilesService:r,AssetsService:o,FoldersService:n}=t;e("items.create",async(s,{collection:i},{schema:f,database:l})=>{if(f===null||i!=="user")return s;let p=new o({knex:l,schema:f}),b=new r({knex:l,schema:f}),w=new n({knex:l,schema:f});if(ae(s)){if(console.log(s.profile),s.profile)return s;let d=await p.getAsset(s.o_profile,{}),g=await L(d.stream),{name:C}=ce.default.parse(d.file.filename_download),de=fe.default.randomBytes(5).toString("hex"),pe=(await w.createOne({name:`${C}-${de}`})).toString(),me=(await ue({folder:pe,buffer:g,originalName:C,service:b})).map(he=>({user_id:"+",directus_files_id:{id:he.toString()}}));s.profile={create:me,update:[],delete:[]}}return s})};0&&(module.exports={});
